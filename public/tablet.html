<!-- /*
 * This file is part of the Companion project
 * Copyright (c) 2018 Bitfocus AS
 * Authors: William Viker <william@bitfocus.io>, Håkon Nessjøen <haakon@bitfocus.io>
 *
 * This program is free software.
 * You should have received a copy of the MIT licence as well as the Bitfocus
 * Individual Contributor License Agreement for companion along with
 * this program.
 *
 * You can be released from the requirements of the license by purchasing
 * a commercial license. Buying such a license is mandatory as soon as you
 * develop commercial activities involving the Companion software without
 * disclosing the source code of your own applications.
 *
 */ -->
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: black;
			font-size: 2em;
			font-family: helvetica;
		}
		.page-title {
			background-color: #000;
			padding: 10px;
			text-align: center;
			text-transform: uppercase;
			margin-top: 0.2em;
			color: rgb(255,198,0);
			font-size: 0.6em;
			padding-top:50px;
			padding-bottom:30px;
		}
		#control {
			position: fixed;
			top:0;
			left:0;
			color: rgb(255,198,0);
			font-size:19px;
			width: 100%;
			padding: 10px;
			background-color: #222;
			border-bottom: 1px solid rgb(255,198,0);
		}
		#banks {
			padding-top: 25px;
		}
		.page-bank {
			margin-top: 0.1em;
			margin-bottom: 0.1em;
			display:inline-block;
		}
		.page-bank-content {
			padding: 0px;
			margin:0.1em;
			color: white;
			background-color: #111;
			border-top: 1px solid #555;
			border-left: 1px solid #333;
			display:table-cell;
			height: 150px;
			width:25%;
			white-space: pre-wrap;
		}
		.page-bank-content canvas {
			height: 100%;
		}
		.page-content {
			display:table;
			width:100%;
		}
	</style>
	<title>Companion Tablet Surface</title>
</head>
<body>
<script src="js/jquery/jquery.min.js"></script>
<script src="socket.io/socket.io.js"></script>
<script src="js/viewport.js"></script>
<script src="js/preview.js"></script>

<div id="control">
	Companion Browser Control
</div>

<div id="banks">
	heh
</div>

<script type="text/javascript">

	var socket = io();
	var config = {};
	var cache = {};
	var visible = {};

	function int2hex(number) {
		var r = ('0' + ((number >> 16) & 0xff).toString('16')).substr(-2);
		var g = ('0' + ((number >> 8) & 0xff).toString('16')).substr(-2);
		var b = ('0' + (number & 0xff).toString('16')).substr(-2);

		return '#' + r + g + b;
	}

	function hex2int(hex) {
		return parseInt(hex.substr(1), 16);
	}

	var $bs =	$("#banks");
	for (var page = 1; page <= 99; page++) {
		var $page = $("<div class='page'></div>");

		var $pageTitle = $("<div class='page-title'>Page "+page+"</div>");
		var $pageContent = $("<table class='page-content'></table>");
		var $pageBankTr = $("<tr></tr>");

		var i = 1;

		for (var bank = 1; bank <= 12; bank++) {
			if (i === 1) {
				$pageBankTr = $("<tr></tr>");
			}
			if (i === 4) {
				i = 0;
				$pageContent.append($pageBankTr);
			}

			var $pageBank = $("<td class='page-bank-content' id='bank_"+page+"_"+bank+"'><canvas id='c"+page+"_"+bank+"'></canvas></td>");
			$pageBankTr.append($pageBank);

			i++;
		}

		$page.append($pageTitle);
		$page.append($pageContent);
		$page.attr('pageid', page);

		$bs.append($page);
	}
	var lastdown;
	var touchdevice = false;

	window.addEventListener('touchstart', function onFirstTouch() {
		touchdevice = true;

		$("body").on('touchstart', '.page-bank-content', function() {
			lastdown = $(this).attr('id').split(/_/);
			console.log("touchstart", $(this).attr('id'));
			if (lastdown[0] === 'bank') {
				socket.emit('hot_press', lastdown[1], lastdown[2], true);
			}
		});

		$("body").on('touchend', '.page-bank-content', function() {
			console.log("touchend", $(this).attr('id'));
			if (lastdown !== undefined && lastdown[0] === 'bank') {
				socket.emit('hot_press', lastdown[1], lastdown[2], false);
			}
		});

		window.removeEventListener('touchstart', onFirstTouch, false);
	}, false);



	$("body").on('mousedown', '.page-bank-content', function() {
		if (!touchdevice) {
			lastdown = $(this).attr('id').split(/_/);
			console.log("mousedown", $(this).attr('id'));

			if (lastdown[0] === 'bank') {
				socket.emit('hot_press', lastdown[1], lastdown[2], true);
			}
		}
	});

	$("body").on('mouseup', '.page-bank-content', function() {
		if (!touchdevice) {
			console.log("mouseup", $(this).attr('id'));
			if (lastdown !== undefined && lastdown[0] === 'bank') {
				socket.emit('hot_press', lastdown[1], lastdown[2], false);
			}
		}
	});

	function drawBank(page, bank, data) {
		console.log("draw bank " + page + "." + bank);

		var canvas = $('#c' + page + '_' + bank).get(0);
		var ctx = canvas.getContext('2d');
		var imageData = dataToButtonImage(data.buffer);
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.putImageData(imageData, 0, 0);
		ctx.drawImage(canvas, 0, 0, canvas.width*2, canvas.height*2);
	}

	$(window).on('scroll', scroll);

	// Lazy load pages
	function scroll() {
		// Not ready
		if (cache[1] === undefined) {
			return;
		}

		$('.page').isInViewport({ tolerance: window.innerHeight }).each(function () {
			var page = $(this).attr('pageid');

			if (cache[page][1] !== undefined || cache[page].wait == true) {
				return;
			}

			var cachedata = {};
			for (var _bank = 1; _bank <= 12; ++_bank) {
				if (cache[page][_bank] !== undefined) {
					cachedata[_bank] = cache[page][_bank].updated;
				}
			}

			socket.emit('web_buttons_page', page, cachedata);
			cache[page].wait = true;
		});
	}

	socket.on('connect', function () {
		socket.on('buttons_page_data', function(page, data) {
			cache[page].wait = false;

			for (var key in data) {
				cache[page][key] = data[key];
				drawBank(page, key, data[key]);
			}
		});
		socket.on('buttons_bank_data', function(page, data) {
			for (key in data) {
				drawBank(page, key, data[key]);
			}
		});
		socket.emit('web_buttons');

		for (var i = 1; i < 100; ++i) {
			cache[i] = {};
			visible[i] = 0;
		}

		scroll();
	});



</script>
</body>
</html>
